# Random_Reply 机器人防尬聊插件

## 简介
为复数机器人群聊设计的防止炸群插件，防止机器人之间无限对话。插件可以对指定用户或群聊进行概率性回复，同时保持对话上下文的连贯性。与传统黑名单不同，弱黑名单用户的消息会被记录到对话历史中，只是不一定会收到回复。插件还支持保底回复机制，确保黑名单用户不会长时间得不到任何回应。

- **基于原项目重构**：本插件基于 [astrbot_plugin_weakblacklist](https://github.com/0d00-Ciallo-0721/astrbot_plugin_weakblackl) 重构而来，针对多机器人场景进行了优化和功能增强

## 功能特点
- **概率性回复**：对黑名单用户/群聊按设定概率决定是否回复
- **保持上下文**：黑名单用户的消息依然会被大语言模型处理并记录到对话历史
- **保底回复机制**：当用户连续被拦截次数达到设定值时，触发强制回复
- **动态管理**：支持通过命令在对话中动态添加/移除黑名单，并自动同步到配置文件
- **独立配置**：用户和群聊黑名单分别配置，可独立启用/禁用
- **识别码保护**：所有命令需要识别码才能执行，避免误触发

## 使用方法

### 管理员命令
- `/rrbot <识别码> help` - 查看命令帮助
- `/rrbot <识别码> list` - 查看当前黑名单列表及每个用户/群的拦截计数状态
- `/rrbot <识别码> add [user|group] <QQ号/群号>` - 在对话中动态添加弱黑名单目标（默认 user）
- `/rrbot <识别码> remove [user|group] <QQ号/群号>` - 移除通过命令添加的弱黑名单目标

**注意**：所有命令都需要先配置 `command_identifier`，否则命令将不可用。

### 配置选项

#### 基础配置
- `command_identifier`（必需）：为该机器人设置命令识别码（指令格式 `/rrbot <识别码> ...`）
  - 为空则禁用所有 `/rrbot` 指令
  - 建议设置为该机器人的唯一标识（如机器人名称）

#### 用户弱黑名单配置（`user_settings`）
- `enable`：是否启用针对用户的弱黑名单逻辑（默认：`true`）
- `reply_probability`：对弱黑名单用户的回复概率（默认：`0.3`，范围 0.0-1.0）
- `max_interception_count`：最大连续拦截次数后触发保底回复（默认：`5`，设置为 0 则禁用保底机制）
- `blacklisted_users`：弱黑名单用户列表（QQ号列表）

#### 群聊弱黑名单配置（`group_settings`）
- `enable`：是否启用针对群聊的弱黑名单逻辑（默认：`true`）
- `reply_probability`：对弱黑名单群聊的回复概率（默认：`0.3`，范围 0.0-1.0）
- `max_interception_count`：最大连续拦截次数后触发保底回复（默认：`8`，设置为 0 则禁用保底机制）
- `blacklisted_groups`：弱黑名单群聊列表（群号列表）

#### 其他配置
- `log_blocked_messages`：是否记录被拦截的消息（默认：`true`）

### 工作原理
1. 当黑名单用户/群聊发送消息时，插件会检查是否应该回复：
   - 如果用户已连续被拦截次数达到最大值，触发保底回复
   - 否则根据设定的概率决定是否回复
2. 如果决定不回复，用户消息仍会被处理但不会收到回复，同时拦截计数+1
3. 如果决定回复（概率通过或保底触发），拦截计数重置为0

### 动态黑名单管理
- 通过 `/rrbot <识别码> add` 添加的黑名单会自动保存到独立文件，并同步到配置文件
- 通过 `/rrbot <识别码> remove` 只能移除通过命令添加的黑名单
- 配置文件中直接添加的黑名单需要通过配置文件或后台管理界面移除
- 动态添加的黑名单在插件重启后仍然有效（已同步到配置）

## 数据存储
插件会在 `data/WeakBlacklist/` 目录下创建以下文件：
- `user_interception_counters.json`：用户拦截计数器
- `group_interception_counters.json`：群聊拦截计数器
- `managed_blacklist.json`：动态维护的黑名单（通过命令添加的）

## 注意事项
- 即使不回复，消息也会被发送到大语言模型处理，可能产生API费用
- 如果要完全屏蔽某用户，建议使用其他黑名单插件
- 将黑名单用户从列表中移除后，其拦截计数会自动清除
- 动态添加的黑名单会自动同步到配置文件，无需手动操作
- 配置中的 `enable` 开关可以临时禁用某类黑名单，而不需要删除列表

## 版本信息
- 版本：v0.3
- 作者：和泉智宏＆柯尔
- 仓库：https://github.com/Luna-channel/random-reply

